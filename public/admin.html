<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - WhatsApp Subscription</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f4f4f4; }
        .form-group { margin-bottom: 15px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Admin Panel - User Management</h1>
    <button onclick="logout()" style="float: right;">Logout</button>
    
    <h2>Users List</h2>
    <table id="usersTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Role</th>
                <th>Subscription Expiry</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Update Subscription</h2>
    <div class="form-group">
        <label>User ID:</label>
        <input type="text" id="userId" required>
    </div>
    <div class="form-group">
        <label>Expiry Date:</label>
        <input type="datetime-local" id="expiryDate" required>
    </div>
    <button onclick="updateSubscription()">Update Subscription</button>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
        }

        async function loadUsers() {
            try {
                const response = await fetch('/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    const tbody = document.querySelector('#usersTable tbody');
                    tbody.innerHTML = '';
                    
                    users.forEach(user => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = user.id;
                        row.insertCell(1).textContent = user.email;
                        row.insertCell(2).textContent = user.role;
                        row.insertCell(3).textContent = user.subscription_expiry ? 
                            new Date(user.subscription_expiry).toLocaleString() : 'None';
                        
                        const actionsCell = row.insertCell(4);
                        if (user.role !== 'admin') {
                            const button = document.createElement('button');
                            button.textContent = 'Select';
                            button.onclick = () => {
                                document.getElementById('userId').value = user.id;
                                if (user.subscription_expiry) {
                                    const date = new Date(user.subscription_expiry);
                                    document.getElementById('expiryDate').value = 
                                        date.toISOString().slice(0, 16);
                                }
                            };
                            actionsCell.appendChild(button);
                        }
                    });
                } else if (response.status === 403) {
                    alert('Access denied. Redirecting to user panel.');
                    window.location.href = '/user';
                } else {
                    alert('Failed to load users');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load users');
            }
        }

        async function updateSubscription() {
            const userId = document.getElementById('userId').value;
            const expiryDate = document.getElementById('expiryDate').value;
            
            try {
                const response = await fetch('/admin/subscription', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        expiry_date: expiryDate + ':00Z'
                    })
                });
                
                if (response.ok) {
                    alert('Subscription updated successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('Update failed: ' + error.detail);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Update failed');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Load users on page load
        loadUsers();
    </script>
</body>
</html>